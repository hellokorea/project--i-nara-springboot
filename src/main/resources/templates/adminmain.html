<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ì„œ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
<div class="admin-container">
    <header class="admin-header">
        <h1>ğŸ“š ê´€ë¦¬ì í˜ì´ì§€</h1>
        <div class="admin-profile">
            <span class="admin-name">ê´€ë¦¬ìë‹˜</span>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </header>

    <main class="admin-main">
        <div class="admin-actions">
            <div class="search-bar">
                <input type="text" placeholder="ë„ì„œëª… ë˜ëŠ” ì €ì ê²€ìƒ‰" id="searchInput">
                <button class="search-btn" onclick="searchBooks()">ê²€ìƒ‰</button>
            </div>
            <div class="action-buttons">
                <button class="add-book-btn" onclick="openAddModal()">ë„ì„œ ë“±ë¡</button>
                <button class="add-event-btn" onclick="openAddEventModal()">ì´ë²¤íŠ¸ ë“±ë¡</button>
            </div>
        </div>

        <div class="books-grid" id="booksGrid">
            <!-- ë„ì„œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ -->
        <div class="pagination" id="pagination">
            <!-- í˜ì´ì§€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
    </main>

    <!-- ë„ì„œ ë“±ë¡ ëª¨ë‹¬ -->
    <div class="modal" id="addBookModal" style="display: none;">
        <div class="modal-content">
            <h2>ë„ì„œ ë“±ë¡</h2>
            <label>ISBN</label><input type="text" id="addIsbn" placeholder="ISBN ì…ë ¥"><br>
            <label>ì œëª©</label><input type="text" id="addTitle" placeholder="ì œëª© ì…ë ¥"><br>
            <label>ë‚´ìš©</label><textarea id="addPlot" placeholder="ë‚´ìš© ì…ë ¥"></textarea><br>
            <label>ì €ì</label><input type="text" id="addAuthor" placeholder="ì €ì ì…ë ¥"><br>
            <label>ì¶œíŒì‚¬</label><input type="text" id="addPublisher" placeholder="ì¶œíŒì‚¬ ì…ë ¥"><br>
            <label>ê¶Œì¥ ì—°ë ¹</label><input type="text" id="addAge" placeholder="ì—°ë ¹ ì…ë ¥"><br>
            <label>ì¹´í…Œê³ ë¦¬</label><input type="text" id="addCategory" placeholder="ì¹´í…Œê³ ë¦¬ ì…ë ¥"><br>
            <label>ì»¤ë²„ ì´ë¯¸ì§€</label><input type="text" id="addCoverImage" placeholder="ì´ë¯¸ì§€ URL ì…ë ¥"><br>
            <button onclick="addBook()" class="modal-btn save-btn">ì €ì¥</button>
            <button onclick="closeAddModal()" class="modal-btn cancel-btn">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ì´ë²¤íŠ¸ ë“±ë¡ ëª¨ë‹¬ -->
    <div class="modal" id="addEventModal" style="display: none;">
        <div class="modal-content">
            <h2>ì´ë²¤íŠ¸ ë“±ë¡</h2>
            <label>ì´ë²¤íŠ¸ ì‹œì‘ ì‹œê°„</label>
            <input type="text" id="eventStartTime" placeholder="ì˜ˆ: 2024-11-03T10:00:00"><br>
            <label>ì´ë²¤íŠ¸ ì¢…ë£Œ ì‹œê°„</label>
            <input type="text" id="eventEndTime" placeholder="ì˜ˆ: 2024-11-03T18:00:00"><br>
            <label>ë‹¹ì²¨ì ìˆ˜</label>
            <input type="number" id="eventWinnerCount" placeholder="ìˆ«ì ì…ë ¥"><br>
            <button onclick="addEvent()" class="modal-btn save-btn">ì €ì¥</button>
            <button onclick="closeAddEventModal()" class="modal-btn cancel-btn">ì·¨ì†Œ</button>
        </div>
    </div>

    <!-- ë„ì„œ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal" id="editBookModal" style="display: none;">
        <div class="modal-content">
            <h2>ë„ì„œ ìˆ˜ì •</h2>
            <label>ISBN</label><input type="text" id="editIsbn" disabled><br>
            <label>ì œëª©</label><input type="text" id="editTitle"><br>
            <label>ë‚´ìš©</label><textarea id="editPlot"></textarea><br>
            <label>ì €ì</label><input type="text" id="editAuthor"><br>
            <label>ì¶œíŒì‚¬</label><input type="text" id="editPublisher"><br>
            <label>ê¶Œì¥ ì—°ë ¹</label><input type="text" id="editAge"><br>
            <label>ì¹´í…Œê³ ë¦¬</label><input type="text" id="editCategory"><br>
            <label>ì»¤ë²„ ì´ë¯¸ì§€</label><input type="text" id="editCoverImage"><br>
            <button onclick="saveBook()" class="modal-btn save-btn">ì €ì¥</button>
            <button onclick="closeEditModal()" class="modal-btn cancel-btn">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    let currentPage = 0;

    document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("Authorization");

        if (!token) {
            window.location.href = "/login";
            return;
        }

        axios.defaults.headers.common["Authorization"] = token;
        loadBookList(currentPage);

        // ì´ë²¤íŠ¸ ë“±ë¡ ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        document.querySelector(".add-event-btn").addEventListener("click", openAddEventModal);
    });

    async function loadBookList(page = 0, searchQuery = null) {
        try {
            const params = { page };
            if (searchQuery) {
                params.search = searchQuery;
            }

            const response = await axios.get(`http://localhost:8080/members/books`, { params });
            const books = response.data.data.books;
            const isLastPage = response.data.data.isLast;

            const booksGrid = document.getElementById("booksGrid");
            booksGrid.innerHTML = "";
            books.forEach(book => {
                const bookCard = document.createElement("div");
                bookCard.classList.add("book-card");
                bookCard.innerHTML = `
                    <div class="book-info">
                        <h3>${book.title}</h3>
                        <p>ISBN: ${book.isbn}</p>
                        <p>ì €ì: ${book.author || "N/A"}</p>
                        <div class="book-actions">
                            <button class="edit-btn" onclick="openEditModal('${book.isbn}')">ìˆ˜ì •</button>
                            <button class="delete-btn" onclick="confirmDelete('${book.isbn}')">ì‚­ì œ</button>
                        </div>
                    </div>
                `;
                booksGrid.appendChild(bookCard);
            });

            setupPagination(page, isLastPage);
        } catch (error) {
            if (error.response && error.response.status === 403) {
                alert("ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                window.location.href = "/login";
            } else {
                console.error("ë„ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            }
        }
    }

    function setupPagination(currentPage, isLastPage) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        if (currentPage > 0) {
            const prevButton = document.createElement("button");
            prevButton.innerText = "ì´ì „";
            prevButton.onclick = () => loadBookList(currentPage - 1);
            pagination.appendChild(prevButton);
        }

        const currentPageButton = document.createElement("button");
        currentPageButton.innerText = `Page ${currentPage + 1}`;
        currentPageButton.disabled = true;
        pagination.appendChild(currentPageButton);

        if (!isLastPage) {
            const nextButton = document.createElement("button");
            nextButton.innerText = "ë‹¤ìŒ";
            nextButton.onclick = () => loadBookList(currentPage + 1);
            pagination.appendChild(nextButton);
        }
    }

    function logout() {
        localStorage.removeItem("Authorization");
        window.location.href = "/login";
    }

    function searchBooks() {
        const searchQuery = document.getElementById("searchInput").value.trim();
        loadBookList(0, searchQuery || null);
    }

    function openAddModal() {
        document.getElementById("addBookModal").style.display = "flex";
    }

    function closeAddModal() {
        document.getElementById("addBookModal").style.display = "none";
    }

    function openEditModal(isbn) {
        document.getElementById("editBookModal").style.display = "flex";
        fetchBookDetails(isbn);
    }

    function closeEditModal() {
        document.getElementById("editBookModal").style.display = "none";
    }

    // ì´ë²¤íŠ¸ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    function openAddEventModal() {
        document.getElementById("addEventModal").style.display = "flex";
    }

    // ì´ë²¤íŠ¸ ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°
    function closeAddEventModal() {
        document.getElementById("addEventModal").style.display = "none";
    }

    // ì´ë²¤íŠ¸ ë“±ë¡ í•¨ìˆ˜
    async function addEvent() {
        const startTime = document.getElementById("eventStartTime").value;
        const endTime = document.getElementById("eventEndTime").value;
        const winnerCount = document.getElementById("eventWinnerCount").value;

        if (!startTime || !endTime || !winnerCount) {
            alert("ëª¨ë“  ê°’ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            return;
        }

        const eventRequest = {
            startTime: startTime,
            endTime: endTime,
            winnerCount: parseInt(winnerCount, 10)
        };

        try {
            const response = await axios.post("http://localhost:8080/admin/event", eventRequest);
            alert("ì´ë²¤íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            closeAddEventModal(); // ëª¨ë‹¬ ë‹«ê¸°
        } catch (error) {
            console.error("ì´ë²¤íŠ¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì´ë²¤íŠ¸ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    async function addBook() {
        const book = {
            isbn: document.getElementById("addIsbn").value,
            title: document.getElementById("addTitle").value,
            plot: document.getElementById("addPlot").value,
            author: document.getElementById("addAuthor").value,
            publisher: document.getElementById("addPublisher").value,
            recommendedAge: document.getElementById("addAge").value,
            coverImage: document.getElementById("addCoverImage").value,
            keywords: "",
            categories: [{ category: document.getElementById("addCategory").value }]
        };
        try {
            await axios.post("http://localhost:8080/admin/books/", book);
            closeAddModal();
            loadBookList(currentPage);
        } catch (error) {
            console.error("ë„ì„œ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    async function saveBook() {
        const isbn = document.getElementById("editIsbn").value;
        const book = {
            title: document.getElementById("editTitle").value,
            plot: document.getElementById("editPlot").value,
            author: document.getElementById("editAuthor").value,
            publisher: document.getElementById("editPublisher").value,
            recommendedAge: document.getElementById("editAge").value,
            coverImage: document.getElementById("editCoverImage").value,
            categories: [{ category: document.getElementById("editCategory").value }]
        };
        try {
            await axios.put(`http://localhost:8080/admin/books/${isbn}`, book);
            closeEditModal();
            loadBookList(currentPage);
        } catch (error) {
            console.error("ë„ì„œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    async function deleteBook(isbn) {
        try {
            await axios.delete(`http://localhost:8080/admin/books/${isbn}`);
            alert("ë„ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadBookList(currentPage);
        } catch (error) {
            console.error("ë„ì„œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    async function fetchBookDetails(isbn) {
        try {
            const response = await axios.get(`http://localhost:8080/members/books/detail/${isbn}`);
            const book = response.data.data;

            document.getElementById("editIsbn").value = book.isbn;
            document.getElementById("editTitle").value = book.title;
            document.getElementById("editPlot").value = book.plot;
            document.getElementById("editAuthor").value = book.author;
            document.getElementById("editPublisher").value = book.publisher;
            document.getElementById("editAge").value = book.recommendedAge;
            document.getElementById("editCategory").value = book.category;
            document.getElementById("editCoverImage").value = book.coverImage;
        } catch (error) {
            console.error("ë„ì„œ ì„¸ë¶€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    function confirmDelete(isbn) {
        if (confirm("ì´ ë„ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            deleteBook(isbn);
        }
    }
</script>
</body>
</html>
